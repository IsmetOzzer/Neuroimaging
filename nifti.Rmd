---
title: "The NIfTI Format"
author: "IO"
date: "22 02 2022"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F,
                      fig.width = 5, fig.height = 5)
```

## NIfTI (Neuroimaging Informatics Technology Initiative)

Görsel analizi için en çok kullanılan dosya formatıdır. Beyin kesit görsellerini üst üste koyarak 3 boyutlu bir array verir. DICOM ise birer kesit olarak kaydedilip birleştirilmez.  

DICOM'daki gibi hastane veya hasta ismini NIfTI kayıt etmez ama görsel metadata bilgileri vardır.

### Additional info for other formats

![](nifti_insertimage_1.png){width=50%}

DICOM dosyalarını NIfTI'ye dönüştürmek için oro.dicom paketinin `dicom2nifti()` fonksiyonu kullanılır.

```{r}
library(dplyr)
library(oro.dicom)

all_slices_T1 <- readDICOM("Neurohacking_data-master/BRAINIX/DICOM/T1/")

hdr_11 <- all_slices_T1$hdr[[11]]
hdr_11[hdr_11$name == "PixelSpacing", "value"]

# for (i in 1:length(all_slices_T1$img)) {
#   assign(x = paste0("img_", i), value = all_slices_T1$img[[i]]) }
```

DICOM'u NIfTI'ye çevirme

```{r}
nii_T1 <- dicom2nifti(all_slices_T1) #change all slices to nifti

d <- dim(nii_T1) #get the dimensions of the nifti slices
d
class(nii_T1)
```

```{r}
image(x = 1:d[1],
      y = 1:d[2],
      nii_T1[,,13],
      col = gray(0:64/64))

```

### oro.nifti package

```{r}
library(oro.nifti)

writeNIfTI(nim = nii_T1,                   #write this nifti file
           filename = "Output_3D_File_11") #with this name

list.files("Neurohacking_data-master/BRAINIX/NIfTI",
           pattern = "Output_3D_File")

nii_t1 <- readNIfTI("Neurohacking_data-master/BRAINIX/NIfTI/t1.nii.gz",
                    reorient = F)
dim(nii_t1)
```

```{r}
print(nii_t1)
```

Important part is the pixel dimensions which tells us that there are 512 rows and 512 cols in each of the 22 images.

## Visualizations

1. There is the default version of visualization 

```{r}
d_ni <- dim(nii_t1)

image(x = 1:d_ni[1],
      y = 1:d_ni[2],
      z = nii_t1[,,11],
      col = gray(0:64/64))
```

2. You can also directly use the nifti object

```{r}
image(nii_t1)
```


```{r}
image(nii_t1,
      z = 11,
      plot.type = "single")
```

Now let's get the image in a nice axial, sagital, and coronal view.

```{r}
orthographic(nii_t1, xyz = c(200,  #200 for the x
                             220,  #220 for the y
                             11))  #11 for the z, which is the slice
```

### Backmapping

Let's look at a nice histogram. This is part of a thing called back mapping in which you get some sort of statistics from matrixes of the image.

```{r histogram}
par(mfrow = c(1,2))

hist(nii_t1[,,11][nii_t1[,,11] > 20],
     breaks = 50,
     probability = T,
     xlab = "T1 Intencities",
     main = "Slice 11")

hist(nii_t1[,,13][nii_t1[,,13] > 20],
     breaks = 50,
     probability = T,
     xlab = "T1 Intencities",
     main = "Slice 13")
```

#### Backmapping one slice

```{r}
bw_300_400 <- ((nii_t1 > 300)       # take the value bigger than 300
                  & (nii_t1 < 400)) # and smaller than 400

nii_t1_mask <- nii_t1

nii_t1_mask[!bw_300_400] = NA # assign NA to everything other than bw_300_400

overlay(nii_t1, nii_t1_mask,  # on top of nii_t1, map (overlay) nii_t1_mask 
        z = 11,               # in slice 11
        plot.type = "single") # single image
```

Yukarıdaki görselde pixel yoğunluğu (intensity) 300 ile 400 arasında olan bölgeler kırmızı ile işaretlenmiş. Bu yoğunluktaki alanlar da white matter'a denk gelmektedir. 

```{r}
overlay(nii_t1, nii_t1_mask)
```

```{r}
orthographic(nii_t1, nii_t1_mask, 
            xyz = c(200, 220, 11),
            text = "Image overlayed with mask",
            text.cex = 1.5)
```

## Basic Data Manipulations

Addition, substraction, multiplication

```{r read kirby data}
mridir <- "Neurohacking_data-master/Kirby21/visit_1/113"  # set the directory for easy access in the code

t1 <- readNIfTI(file.path(mridir, "113-01-MPRAGE.nii.gz"), 
                reorient = F)
```

```{r}
orthographic(t1) 
```

```{r reading the mask}
mask <- readNIfTI(file.path(mridir, "113-01-MPRAGE_mask.nii.gz"), 
                  reorient = F)

orthographic(mask)
```

Mask is 0 for the things we don't want and 1 for the things we want, if we multiply the real image with the mask, all the areas we don't want will be 0'ed and all the area we want will be multiplied by 1 (meaning they will be themselves).

```{r}
masked_t1 <- t1*mask

orthographic(masked_t1)
```

One important point is that mask and the T1 image have to be the same size. (e.g. 512 x 512 x 22 for both)

#### Follow up of T1

This patient had a break in between sessions (maybe went for a coffee break) and came back to do the rest of the imaging sessions.  

```{r}
t1.follow <- readNIfTI("Neurohacking_data-master/kirby21/visit_2/113/113-02-MPRAGE.nii.gz")

orthographic(t1.follow)
```

In a substaction, the operation goes as follow: firstVoxel1 - followVoxel1, firstVoxel2 - followVoxel2, ...  

```{r}
t1.substacted <- t1.follow - t1
summary(t1.substacted)
```

But the important lesion here is even if two imaging sessions are from the same person, same machine, same day 30 min apart, the results are trastically different as it is seen from the min and the max values above.

```{r}
orthographic(t1.substacted)
```











